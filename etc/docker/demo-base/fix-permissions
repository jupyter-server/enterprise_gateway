#!/bin/bash
# set permissions on a directory
# after any installation, if a directory needs to be (human) user-writable,
# run this script on it.
# It will make everything in the directory owned by the group $NB_GID
# and writable by that group.
# Deployments that want to set a specific user id can preserve permissions
# by adding the `--group-add users` line to `docker run`.

# uses find to avoid touching files that already have the right permissions,
# which would cause massive image explosion

# right permissions are:
# group=$NB_GID
# AND permissions include group rwX (directory-execute)
# AND directories have setuid,setgid bits set

set -e

# Debug: Check if NB_GID is set
if [ -z "$NB_GID" ]; then
    echo "ERROR: NB_GID environment variable is not set!" >&2
    exit 1
fi

echo "DEBUG: NB_GID is set to: $NB_GID"

# Check if the group exists
if ! getent group "$NB_GID" > /dev/null 2>&1; then
    echo "WARNING: Group with GID $NB_GID does not exist in /etc/group" >&2
    echo "DEBUG: Available groups:" >&2
    getent group | head -5 >&2
    echo "..." >&2
fi

for d in "$@"; do
  find "$d" \
    ! \( \
      -group "$NB_GID" \
      -a -perm -g+rwX  \
    \) \
    -exec chgrp "$NB_GID" {} \; \
    -exec chmod g+rwX {} \;
  # setuid,setgid *on directories only*
  find "$d" \
    \( \
        -type d \
        -a ! -perm -6000  \
    \) \
    -exec chmod +6000 {} \;
done
